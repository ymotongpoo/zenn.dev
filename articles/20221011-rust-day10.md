---
title: "Rustの勉強 10日目"
emoji: "🦀"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["rust", "exercise"]
published: false
---

## The Rust Programming Language 日本語版 第10章

ジェネリクスとトレイトとライフタイムについて。

### 10.1 ジェネリックなデータ型

* 多くのジェネリクスを持つ言語のように、型引数にまず `T` を使う。（これは慣例）
* ジェネリクスを持つ関数の場合は次のように関数名の直後に型引数を与えて宣言する

```rust
fn largest<T>(list: &[T]) -> T { ... }
```

* 関数内の `T` に対する振る舞い次第で `T` が特定のトレイトを持っている必要が有ることを指定する必要がでてくる
  * 例えば比較であれば `std::cmp::PartialOrd` トレイトを持つ必要がある
  * トレイトに関しては次節で説明
* 構造体の定義では構造体名のあとに型引数を与える
  * フィールドごとに異なる型を持たせたかったら、型引数を複数用意してあげる

```rust
struct Point<T, U> {
    x: T,
    y: U,
}
```

* Enumの定義でも同様

```rust
enum Result<T, E> {
    Ok(T),
    Err(E),
}
```

* メソッドの定義の場合は `impl` キーワードの直後に型引数を与えることに注意
  * これでimpl宣言内での `Point<T>` の `T` が具体的な型ではなくジェネリックな型であることを伝える

```rust
impl<T> Point<T> {
    fn x(&self) -> &T {
        &self.x
    }
}
```

* Rustでは多相な型をコンパイル時に単相化することで実行スピードを犠牲にしないようにしている

### 10.2 トレイト: 共通の振る舞いを定義する

* トレイトは他の言語でインターフェースと呼ばれる機能に似ている
* `trait` キーワードで宣言
  * メソッドシグネチャを羅列する
  * トレイトを実装する際には `impl` キーワードに `for` で指定する

```rust
trait Summary {
    fn summerize(&self) -> String;
}

impl Summary for NewsArticle {
    fn summerize(&self) -> String {
        format!("{}, by {} ({})", self.headline, self.author, self.location)
    }
}
```

* トレイトを公開したい場合には他と同様に `pub` キーワードで行う
* 外部のトレイトを外部の型に対して実装することは不可能（これができてしまうと例えば標準ライブラリの型の振る舞いを勝手に変えることができてしまう）
* デフォルトのメソッド定義をしておくと、トレイトの実装を簡便かつ共通にできる
  * カスタム実装がある場合にはオーバーライドされる

```rust
trait Summary {
    fn summarize(&self) -> String {
        String::from("(Read more...)")
    }
}

impl Summary for NewsArticle {} // summarizeはデフォルト実装が採用される
```

* トレイトを関数の引数として受け取れる
  * `fn notify(item: &impl Summary)`
  * これはトレイト境界の糖衣構文
* トレイトをジェネリック型の制約として指定できる（トレイト境界）
  * `fn notify<T: Summary>(item: &T)`
* 複数の引数がある場合にはトレイト境界をきちんと与えるほうがわかりやすい気がする
  * たとえば次の例だと(1)と(2)は同じだけど、`item1`と`item2`が同じ型であることを強制させるためには(3)のようにしないといけない

```rust
fn notify(item1: &impl Summary, item2: &impl Summary) {...} // (1)

fn notify<T: Summary, U: Summary>(item1: &T, item2: &U) {...} // (2)

fn notify<T: Summary>(item1: &T, item2: &T) {...} // (3)
```

* 複数のトレイトを実装していることを求める場合には `+` で指定する
  * `fn notify(item: &(impl Summary + Display))`
  * `fn notify<T: Summary + Display>(item: &T)`
* しかし実装すべきトレイとが多いときは `where` でトレイト境界を後置したほうが読みやすくなると思う

```rust
fn some_function<T, U>(t: &T, u: &U) -> i32
    where T: Display + Clone,
          U: Clone + Debug
{
    ...
}
```

* ブランケット実装とかいう特定のトレイトを満たす型に対して実装するトレイトが強い
  * 次のコードは `Display` トレイトを満たすすべての型 `T` に対して `ToString` トレイトを実装している

```rust
impl<T: Display> ToString for T { ... }
```
