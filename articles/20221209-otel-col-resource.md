---
title: "OpenTelemetry Collectorã§GKEã®ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±ã‚’è‡ªå‹•ã§åŸ‹ã‚è¾¼ã‚€"
emoji: "ğŸ“°"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GoogleCloud", "GCP", "OpenTelemetry", "GKE", "CloudTrace"]
published: false
published_at: 2022-12-15 09:00
---

ã“ã‚“ã«ã¡ã¯ï¼Google Cloudã§ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã‚’æ‹…å½“ã—ã¦ã„ã‚‹ã‚‚ã®ã§ã™ï¼ã“ã®è¨˜äº‹ã¯[Google Cloud Japan Advent Calender 2022](https://zenn.dev/google_cloud_jp/articles/12bd83cd5b3370)ã®15æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

## TL;DR

OpenTelemetry Collectorã‚’ä½¿ãˆã°ã€GKEãªã©ã®è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã§å…±é€šãªãƒªã‚½ãƒ¼ã‚¹æƒ…å ±ã‚’ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ã«ã¾ã¨ã‚ã¦è¿½åŠ ã§ãã¦ã€ã‚ã¡ã‚ƒãã¡ã‚ƒä¾¿åˆ©ãªã‚“ã§ã€ãœã²ä½¿ã£ã¦ã¿ã¦ãã ã•ã„ï¼

:::message
ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±

* OpenTelemetry Collector Contrib: v0.66.0
* OpenTelemetry for Go for Trace: v1.11
:::

## OpenTelemetry Collectorã¨ã¯

ã€Œãã‚‚ãã‚‚[OpenTelemetry Collector](https://opentelemetry.io/docs/collector/)ãªã‚“ã¦çŸ¥ã‚‰ãªã„ã‚ˆï¼ã€ã£ã¦ã„ã†æ–¹ã‚‚ã„ã‚‰ã£ã—ã‚ƒã‚‹ã¨æ€ã„ã¾ã™ã€‚ã¨ã„ã†ã‹ã€ã€Œ[OpenTelemetry](https://opentelemetry.io/)è‡ªä½“çŸ¥ã‚‰ãªã„ã‚ˆï¼ã€ã¨ã„ã†æ–¹ã‚‚ã„ã‚‰ã£ã—ã‚ƒã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãã†ã„ã†æ–¹ã«ã¤ã„ã¦ã¯æ‰‹å‰å‘³å™Œã§ã™ãŒã€ã“ã¡ã‚‰ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

@[card](https://ymotongpoo.hatenablog.com/entry/2020/06/01/164221)

OpenTelemetry Collectorã¯ãƒ­ã‚°ã€ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã€ãƒˆãƒ¬ãƒ¼ã‚¹ã¨ã„ã£ãŸãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ã‚’åé›†ã€é€ä¿¡ã™ã‚‹ãŸã‚ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã€ã“ã‚Œã‚’ä½¿ã†ã“ã¨ã§è¤‡é›‘ãªãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹æˆã™ã‚‹ã“ã¨ãŒå¯èƒ½ã¨ãªã£ã¦ã„ã¾ã™ã€‚

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨ˆè£…ã™ã‚‹éš›ã®èª²é¡Œç‚¹

OpenTelemetryã‚’ä½¿ã„ãŸããªã‚‹çŠ¶æ³ã¨ã„ã†ã®ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦è¨ˆè£…ã‚’ã—ã€ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¦ã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«é€ä¿¡ã—ãŸã„ã¨ããªã‚ã‘ã§ã™ãŒã€ãã®éš›ã«èª²é¡Œã¨ãªã£ã¦ãã‚‹ã®ã¯è¨ˆè£…ã«å¿…è¦ãªã‚³ãƒ¼ãƒ‰é‡ã§ã™ã€‚

ãŸã¨ãˆã°æ¬¡ã¯ãƒˆãƒ¬ãƒ¼ã‚¹ã‚’ç”Ÿæˆã™ã‚‹éš›ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã§ã™ãŒã€éå¸¸ã«å¤šãã®å±æ€§ãŒå®£è¨€ã•ã‚Œã¦ã„ã¾ã™ã€‚

```go
    ...
	res, err := resource.New(
		context.Background(),
		resource.WithAttributes(
			semconv.ServiceNameKey.String("service-a"),
			semconv.ServiceVersionKey.String("1.0.0"),
			semconv.DeploymentEnvironmentKey.String("production"),
			semconv.TelemetrySDKNameKey.String("opentelemetry"),
			semconv.TelemetrySDKLanguageKey.String("go"),
			semconv.TelemetrySDKVersionKey.String("0.13.0"),
		),
	)
    ...
```

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ã®å±æ€§ã«é–¢ã—ã¦ã¯ã¾ã å€‹åˆ¥ã«è¨ˆè£…ã™ã‚‹ã»ã‹ãªã„ã§ã™ãŒã€ã“ã‚Œä»¥å¤–ã«ã‚‚ä¾‹ãˆã°Google Cloudã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚„ã€ã“ã®ä¾‹ã«ã‚‚æ›¸ã„ã¦ã‚ã‚‹ã‚ˆã†ãªå®Ÿè¡Œç’°å¢ƒã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã€ã‚ã‚‹ã„ã¯Kubernetesã®ç¨¼åƒä¸­ã®ã‚¯ãƒ©ã‚¹ã‚¿åãªã©ã‚’åŸ‹ã‚è¾¼ã¿ãŸã„ã¨ã£ãŸå ´åˆã«ã¯ã€é–¢é€£ã™ã‚‹å…¨ã‚µãƒ¼ãƒ“ã‚¹ã§æ›¸ãå¿…è¦ãŒã‚ã‚‹ãŸã‚ã€è¨ˆè£…ã®ã‚³ãƒ¼ãƒ‰ãŒè†¨ã‚Œä¸ŠãŒã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ã¾ãŸã€åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’åˆ¥ã®ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆãªã©ã«ã¯ã€ç’°å¢ƒå¤‰æ•°ãªã©ã‹ã‚‰å€¤ã‚’å·®ã—è¾¼ã‚€å¿…è¦ãŒã§ã¦ãã‚‹ãŸã‚ã€è¨ˆè£…ä¸Šã§ã¯ç’°å¢ƒå¤‰æ•°ã®å‚ç…§ã—ã‹ã—ã¦ã„ãªãã¦ã‚‚ã€ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ã“ã†ã—ãŸéœ€è¦ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã¯ã„ãã¤ã‹ã®æ–¹æ³•ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§å®Ÿè¡Œç’°å¢ƒãªã©ã‚’è‡ªå‹•ã§æ¤œçŸ¥ã—ã¦å±æ€§ã«å·®ã—è¾¼ã‚€
2. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚„ãƒ—ãƒ­ã‚­ã‚·ãƒ¼ãªã©ã«å¯¾ã—ã¦é€ä¿¡ã—ã€é€ä¿¡å…ˆã§å±æ€§ã‚’å·®ã—è¾¼ã‚€

1ã«é–¢ã—ã¦ã¯ã€ã„ãã¤ã‹è‡ªå‹•è¨ˆè£…ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒã‚ã‚‹ã®ã§ã€ãã‚Œã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ãˆã™ã‚Œã°ã‚ã‚‹ç¨‹åº¦ã‚«ãƒãƒ¼ã§ãã‚‹ã®ã§ã™ãŒã€ä¸€æ–¹ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¢—ãˆã¾ã™ã—ã€ã™ã¹ã¦ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’è¿½åŠ ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

2ã«é–¢ã—ã¦ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®ã‚³ãƒ¼ãƒ‰ã‚’ç·¨é›†ã™ã‚‹ã“ã¨ç„¡ã„ãŸã‚ä¾¿åˆ©ã§ã¯ã‚ã‚‹ã®ã§ã™ãŒã€ä¸€æ–¹ã§ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ç·¨é›†ã®ãŸã‚ã®è¿½åŠ ã®å±¤ãŒå¿…è¦ã«ãªã£ã¦ãã¾ã™ã€‚

ä¸€é•·ä¸€çŸ­ã§ã¯ã‚ã‚Šã¾ã™ãŒã€OpenTelemetryã‚’ä½¿ã£ãŸè¨ˆè£…ã®å ´åˆã€Collectorã‚’ä½¿ã†æ§‹æˆãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã€ã“ã®è¨˜äº‹ã§ã¯2ç•ªã‚ã®æ–¹æ³•ã‚’ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## OpenTelemetry Collectorã®processor

OpenTelemetry Collectorã¯å¤§ããåˆ†ã‘ã¦3ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æ§‹æˆã•ã‚Œã¦ã„ã¦ã€ã“ã®3ã¤ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãã‚Œãã‚Œãƒ—ãƒ©ã‚°ã‚¤ãƒ³å½¢å¼ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚

* receiver: ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€OpenTelemetry Collectorå†…éƒ¨ã®æ¨™æº–å½¢å¼ï¼ˆä»¥ä¸‹ã€Œæ¨™æº–å½¢å¼ã€ï¼‰ã«å¤‰æ›ã™ã‚‹éƒ¨åˆ†
* processor: æ¨™æº–å½¢å¼å†…ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†ã™ã‚‹éƒ¨åˆ†
* exporter: æ¨™æº–å½¢å¼ã‹ã‚‰å„ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å‘ã‘ã®ãƒ‡ãƒ¼ã‚¿å½¢å¼ã«å¤‰æ›ã—ã€é€ä¿¡ã™ã‚‹éƒ¨åˆ†

ãŸã¨ãˆã°Prometheus(OpenMetrics)å½¢å¼ã§è¨ˆè£…ã•ã‚Œã¦ã„ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã£ãŸå ´åˆã«ã¯ã€[Prometheus receiver](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/prometheusreceiver/README.md)ã‚’ä½¿ãˆã°ã€æ¨™æº–å½¢å¼ã¸å¤‰æ›ãŒã§ãã€ã•ã‚‰ã«ãã‚Œä»¥å¤–ã®OpenTelemetryã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã‚’æ´»ç”¨ã§ãã‚‹ã€ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ä»Šå›ã¯ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼å†…ã«ç’°å¢ƒæƒ…å ±ã‹ã‚‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ãŸã„ã¨ã„ã†ã“ã¨ãªã®ã§ã€ãã‚Œç”¨ã®processorã‚’è¿½åŠ ã—ã¾ã™ã€‚

## Resource Detection Processor

@[card](https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/resourcedetectionprocessor)

ã“ã®Resource Detection Processorã¨ã„ã†processorã¯ã€Google Cloudã‚’å§‹ã‚ã¨ã™ã‚‹ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚µãƒ¼ãƒ“ã‚¹ã«ãŠã‘ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±ã‚„ã€å‹•ä½œã•ã›ã¦ã„ã‚‹ç’°å¢ƒã®OSé–¢é€£æƒ…å ±ãªã©ã‚’è‡ªå‹•ã§æ¤œçŸ¥ã—ã€å¿…è¦ãªã‚‚ã®ã‚’ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ã«åŸ‹ã‚è¾¼ã‚“ã§ãã‚Œã‚‹ã€ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

ã“ã‚Œã¯OpenTelemetryãŒæ‰±ã†ã™ã¹ã¦ã®ç¨®é¡ã®ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ¼ã«å¯¾ã—ã¦å®Ÿæ–½ã—ã¦ãã‚Œã‚‹ã®ã§ã€ãŸã¨ãˆã°ãƒˆãƒ¬ãƒ¼ã‚¹ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’OpenTelemetry CollectorçµŒç”±ã§é€ä¿¡ã—ã¦ã„ã‚‹å ´åˆã«ã¯ã€ã“ã‚Œã‚’ä½¿ã†ã ã‘ã§ä¸¡æ–¹ã«ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±ã‚’è¿½åŠ ã—ã¦ãã‚Œã¾ã™ã€‚ä¾¿åˆ©ã§ã™ã­ï¼ï¼ï¼

## ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

èª¬æ˜ã®ãŸã‚ã«ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚ï¼ˆTODO: PRãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚‰URLã‚’ç½®ãæ›ãˆã‚‹ï¼‰

@[card](https://github.com/ymotongpoo/devrel-demos/tree/otel-gke-add-labels/devops/otel-collector/gke-add-labels)

```mermaid
flowchart LR
    idA(service A) -- OTLP --> collector
    idB(service B) -- OTLP --> collector
    collector --> idT(Cloud Trace)
```

ã‚µãƒ¼ãƒ“ã‚¹Aã¨ã‚µãƒ¼ãƒ“ã‚¹BãŒãã‚Œãã‚Œãƒˆãƒ¬ãƒ¼ã‚¹ã‚’Collectorã«å‘ã‹ã£ã¦é€ä¿¡ã—ã¦ã„ã¦ã€Collectorå†…éƒ¨ã§GKEã‚„Google Cloudé–¢é€£ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ãƒˆãƒ¬ãƒ¼ã‚¹ã«åŸ‹ã‚è¾¼ã‚“ã§ã„ã¾ã™ã€‚

Collectorç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚ï¼ˆãƒ‡ãƒ¢ã§ã¯ã“ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯Kubernetesã®ConfigMapã«ãªã£ã¦ã„ã¾ã™ã€‚ï¼‰

```yaml
receivers:
    otlp:
        protocols:
            grpc:
processors:
    batch: {}
    resourcedetection:
        detectors: [gke, gce]
        override: false
exporters:
    logging:
    googlecloud:
    retry_on_failure:
        enabled: true
    log:
        default_log_name: opentelemetry.io/collector-exported-log
service:
    pipelines:
    traces:
        receivers: [otlp]
        processors: [batch, resourcedetection]
        exporters: [logging, googlecloud]
```

ã“ã®ãƒ‡ãƒ¢ã‚’å®Ÿéš›ã«å‹•ä½œã•ã›ã¦ã¿ã‚‹ã¨ã©ã†ãªã‚‹ã‹è¦‹ã¦ã¾ã—ã‚‡ã†ã€‚

![](/images/20221215-1.png)

å³å´ã®ãƒšã‚¤ãƒ³ã«ã‚ã‚‹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

![](/images/20221215-2.png)

ã“ã“ã«è¼‰ã£ã¦ã„ã‚‹æ¬¡ã®å±æ€§ã¯ã™ã¹ã¦è‡ªå‹•ã§è¿½åŠ ã•ã‚ŒãŸã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ï¼ï¼

* cloud.account.id: development-215403
* cloud.platform: gcp_kubernetes_engine
* cloud.provider: gcp
* cloud.region: asia-east1
* g.co/r/k8s_cluster/cluster_name: otel-sample
* g.co/r/k8s_cluster/location: asia-east1
* k8s.cluster.name: otel-sample



