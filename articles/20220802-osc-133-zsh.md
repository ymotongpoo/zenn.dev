---
title: "Zshã§OSC 133ã«å¯¾å¿œã™ã‚‹"
emoji: "ğŸš"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["zsh", "terminal"]
published: true
---

[OSC 133](https://gitlab.freedesktop.org/Per_Bothner/specifications/blob/master/proposals/semantic-prompts.md)ã¨ã„ã†ä»•æ§˜ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯ã‚·ã‚§ãƒ«ã‚„REPLã§ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¨å®Ÿè¡Œçµæœã®å‡ºåŠ›ã‚’ä¸€ã¾ã¨ã¾ã‚Šå˜ä½ã¨ã—ã¦æ‰±ã†ãŸã‚ã®ãƒãƒ¼ã‚¯ã‚’æ±ºã¾ã£ãŸã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã§è¡Œã†ã“ã¨ã§ã€ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒè§£é‡ˆã§ãã‚‹ã‚ˆã†ã«ã—ã‚ˆã†ã¨ã„ã†ææ¡ˆã§ã™ã€‚

æœ€è¿‘ã®ãƒ¢ãƒ€ãƒ³ãªã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯ã“ã‚Œã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¦ã€ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ãªæœ‰åãªã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

* [iTerm2](https://iterm2.com/documentation-escape-codes.html)
* [WezTerm](https://github.com/wez/wezterm/issues/115)
* [Alacritty](https://github.com/alacritty/alacritty/issues/5850)
* [Kitty](https://sw.kovidgoyal.net/kitty/shell-integration/#how-it-works)
* [VS Code](https://code.visualstudio.com/docs/terminal/shell-integration)

è‡ªåˆ†ã¯æœ€è¿‘[WezTerm](https://wezfurlong.org/wezterm/)ã«ç§»è¡Œã—ãŸã‚ã‘ã§ã™ãŒã€WezTermã§ã¯[ScrollToPrompt](https://wezfurlong.org/wezterm/config/lua/keyassignment/ScrollToPrompt.html?highlight=scroll%20prompt#scrolltoprompt)ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã£ã¦ã€ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã§ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®å…ˆé ­ã‚’å¸¸ã«ç›´å‰ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ã™ã‚‹ã¨ã„ã†ä¾¿åˆ©ãªã“ã¨ãŒã§ãã¾ã™ã€‚ï¼ˆä¾‹ãˆã°ã€å‡ºåŠ›çµæœãŒé•·ã„ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã¨ãã«ä¾¿åˆ©ï¼‰

ã“ã‚Œã‚’ãœã²ä½¿ã„ãŸã„ã¨ã„ã†ã“ã¨ã§ã€è¨­å®šã‚’ç¢ºèªã—ãŸã¨ã“ã‚ã€å…ˆã®ä»•æ§˜ææ¡ˆã«[zshã§ã®è¨­å®šæ–¹æ³•ã®ä¾‹](https://gitlab.freedesktop.org/Per_Bothner/specifications/-/blob/master/proposals/prompts-data/shell-integration.zsh)ãŒæ›¸ã„ã¦ã‚ã‚Šã¾ã—ãŸã€‚

```shell
_prompt_executing=""
function __prompt_precmd() {
    local ret="$?"
    if test "$_prompt_executing" != "0"
    then
      _PROMPT_SAVE_PS1="$PS1"
      _PROMPT_SAVE_PS2="$PS2"
      PS1=$'%{\e]133;P;k=i\a%}'$PS1$'%{\e]133;B\a\e]122;> \a%}'
      PS2=$'%{\e]133;P;k=s\a%}'$PS2$'%{\e]133;B\a%}'
    fi
    if test "$_prompt_executing" != ""
    then
       printf "\033]133;D;%s;aid=%s\007" "$ret" "$$"
    fi
    printf "\033]133;A;cl=m;aid=%s\007" "$$"
    _prompt_executing=0
}
function __prompt_preexec() {
    PS1="$_PROMPT_SAVE_PS1"
    PS2="$_PROMPT_SAVE_PS2"
    printf "\033]133;C;\007"
    _prompt_executing=1
}
preexec_functions+=(__prompt_preexec)
precmd_functions+=(__prompt_precmd)
```

ã“ã‚Œã‚’ `.zshrc` ã«è¨˜è¿°ã—ã¦ã¿ãŸã¨ã“ã‚ã€ç„¡äº‹ã«OSC 133ã®ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ã¦å¿«é©ã“ã®ä¸Šãªã„ã§ã™ï¼
